# TODO
## 고려한 문제점
### 1. newCMD에서 db.Close하는 것이 문제
```go
defer func() {
   _ = db.Close()
}()
```
- db.close가 ServerStart의 blocking에 의존적 -> ServerStart가 고루틴으로 변경되면 조짐
  - 애플리케이션 종료 시점의 책임 O 
  - CMD 생성자의 책임 X
- main으로 보내는게 좋음. 따라서 방법을 강구해야함

---

### 2. config.Database 안의 Mutex 싱글톤 문제
#### 1. config가 하는게 너무 많음
```go
var (
	dbMutex      sync.Mutex
	dbConnection *sql.DB
)
```
- config의 역할 : env 파싱, 각종 설정 값
- 현재 : 기본 역할 + db 커넥션 생성 + 풀 관리 + 싱글톤

따라서 config와 infra 컨테이너 요소가 결합됨.

#### 2. test가 어려워짐
```go
cfg := config.NewConfig(...)
db := cfg.Database.NewConnection()
```
- 테스트마다 같은 전역 DB 
- 병렬 테스트 불가 
- mock DB 주입 불가

#### 3. DB 늘어나면 구조가 이상해짐
- read / write 분리 
- replica 
- 다른 DB 타입

확장 여지가 없음

---

## 그래서 뭘 할까
### 1. config.Database → 값 객체로만 유지
- 값 객체만 유지
- NewConnection, Close, 전역 변수 전부 
- [x] ***is it Done?***
### 2. infra/db 패키지 따로 만들기
```go
package db

func New(cfg config.Database) (*sql.DB, error) {
	dsn := fmt.Sprintf(...)

	conn, err := sql.Open("mysql", dsn)
	if err != nil {
		return nil, err
	}

	conn.SetMaxOpenConns(10)
	conn.SetMaxIdleConns(10)
	conn.SetConnMaxLifetime(30 * time.Minute)

	if err := conn.Ping(); err != nil {
		conn.Close()
		return nil, err
	}

	return conn, nil
}
```
- 싱글톤 필요없음
- sql.DB 자체가 커넥션 풀
- 여러 번 만들어도 안전하다고 함
- [x] ***is it Done?***

### 3. cmd.NewCmd에서 생명주기 관리
```go
db, err := db.New(cfg.Database)
if err != nil {
	return nil, err
}

repo := repository.NewRepository(db)
svc := service.NewService(repo)
net := network.NewNetwork(svc)

go func() {
	if err := net.ServerStart(cfg.Server.Port); err != nil {
		log.Fatal(err)
	}
}()
```
- 또한, 고루틴으로 전환하면서 main이 종료되지 않도록, 책임을 어디서 질지! 고려
- [x] ***is it Done?***

## 추가적으로 고려되는것
### 1. RequestDTO에 대한 검증
- 인터페이스처럼 필드만 충족되면 되네?
- 한정지을 필요가 있겠다.
- 일반적으로는 신경쓰지 않아도 된다!
- [x] ***is it Done?***

### 2. Cmd에 config를 필드로 둘 필요가 있을까?
- cmd.Run에서 Graceful Shutdown을 구현하니, config.Server 정보를 가져와야함
- 따라서 유지
- 언제 또 사용할지 모름
- [x] ***is it Done?***

### 3. close는 main에서 해야하는가? cmd의 요소를 노출시키고 싶지는 않은데..
- cmd.Run -> cmd.network.ServerStop -> ListenAndServe
- cmd에서 graceful shutdown (Run) 구현
- signal이 채널에 들어오면 리소스들 정리
- [x] ***is it Done?***
